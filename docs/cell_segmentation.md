
### 5. Cell-level Segmentation in Epidermis  
**Script**: `ihc_cellpose.py`

---

#### Purpose  
Perform cell-level segmentation within epidermal regions of immunohistochemistry (IHC) images using the Cellpose framework.

---

#### Description  
The `ihc_cellpose.py` script implements a Cellpose-based pipeline for cell-level segmentation of IHC images. It operates downstream of the whole-slide tissue segmentation workflow and restricts analysis to epidermal regions identified in earlier steps, ensuring biologically meaningful cell segmentation.

---

#### Main Workflow  
```plaintext
1. Load epidermis tissue masks generated by whole-slide inference
2. Restrict analysis to epidermal regions and exclude background
3. Crop images to biologically relevant regions
4. Apply color deconvolution (RGB → HED)
5. Extract and preprocess hematoxylin channel
6. Run Cellpose `cyto2` model for cell segmentation
7. Map predicted cell masks back to full-resolution image coordinates
````

---

#### Key Features

* **Cellpose-based cell segmentation**

  * Applies the Cellpose `cyto2` model to segment individual cells

* **Integration with tissue-level segmentation**

  * Uses whole-slide epidermis masks to:

    * Restrict analysis to epidermal regions
    * Exclude non-tissue and background areas
    * Focus segmentation on biologically relevant tissue

* **Color deconvolution–based preprocessing**

  * RGB → HED color space conversion
  * Hematoxylin channel extraction
  * Intensity inversion and histogram equalization to enhance nuclear contrast

* **Automated batch processing**

  * Images loaded directly from URLs stored in a local HPA-derived SQLite database
  * Automatic resume using a persistent `last_processed_id`

* **Reproducible, versioned outputs**

  * Outputs stored in versioned directories
  * Metadata captures model configuration, preprocessing steps, and runtime statistics

---

#### Outputs

* Full-resolution cell segmentation masks (`.npz`)
* Multi-panel visualization figures showing preprocessing and segmentation stages
* `run_metadata.json` documenting configuration and processing statistics
* Persistent `last_processed_id.txt` for automatic resumption

---

#### Usage

```bash
python3 -m scripts.epidermis_analysis.ihc_cellpose \
  --version v001 

```

---

#### Configuration

Pipeline parameters are loaded from:

* `base_config.yaml`
* `prediction_config.yaml`

---

#### Integration Flow

```plaintext
data_preprocessing.py
       │
       ▼
Cropped H&E / mask / IHC images
       │
       ▼
train.py
(deep learning tissue segmentation model training)
       │
       ▼
whole_slide_prediction.py
(whole-slide tissue segmentation + refinement)
       │
       ▼
Epidermis tissue masks
       │
       ▼
ihc_cellpose.py
(cell-level segmentation within epidermis)
       │
       ▼
Cell masks
+ visualization summaries
+ run metadata
```

---

#### Publication / Figure Summary

> Cell-level segmentation of immunohistochemistry images was performed using a Cellpose-based pipeline. Epidermal regions identified by a preceding whole-slide segmentation model were isolated and processed using color deconvolution to extract the hematoxylin channel. The Cellpose cyto2 model was applied to generate full-resolution cell masks. Outputs include segmentation masks, visualization summaries, and metadata files stored in a reproducible, versioned directory structure.

---

#### Methods

Cell-level segmentation of immunohistochemistry (IHC) images was performed using a custom pipeline based on the Cellpose framework. Whole-slide tissue segmentation masks generated by a deep learning model were used to identify epidermal regions, restricting downstream analysis to biologically relevant tissue and excluding background regions.

Epidermal regions were cropped using tissue mask bounding boxes, and color deconvolution was applied by converting RGB images to hematoxylin–eosin–DAB (HED) color space. The hematoxylin channel was extracted, inverted, and histogram-equalized to enhance nuclear and cellular contrast. Cell segmentation was then performed using the Cellpose cyto2 model without manual parameter tuning.

Predicted cell masks were mapped back to the original image coordinate space to generate full-resolution outputs. All results were stored in a versioned directory structure, including compressed segmentation masks, visualization summaries, and metadata documenting preprocessing steps, model configuration, and processing statistics. The pipeline supports automatic resumption of interrupted runs, enabling robust large-scale analysis.

